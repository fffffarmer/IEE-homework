









<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
	<title>上海交通大学校友统一身份认证-手机验证</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
	<script src="https://register.alumni.sjtu.edu.cn/UI/jquery/jquery-1.8.3.min.js" type="text/javascript"></script>
	<!-- artDialog -->
	<script src="https://register.alumni.sjtu.edu.cn/UI/artdialog/artDialog.js?skin=darkblue" type="text/javascript"></script>
	<script src="https://register.alumni.sjtu.edu.cn/UI/artdialog/iframeTools.js" type="text/javascript"></script>
	<link href="https://register.alumni.sjtu.edu.cn/UI/css/pwd.css" rel="stylesheet" type="text/css" />
	<script type="text/javascript">
	$(document).ready(function(){
		if(top.location.host!=location.host){
			top.location.href = location.href;
		}
		var userAgent = navigator.userAgent.toLowerCase();
		if(userAgent.indexOf('mobile')>0){
			$('.header').css({
				'width':'auto',
				'height':'auto',
				'padding-bottom':'20px'
			});
			$('.header img').css({
				'max-width':'100%'
			});
			$('.alumniPwd .mainCnt,.alumniPwd .line').css('width','auto');
			$('.alumniPwd .pwdTop,.alumniPwd .pwdFooter').css({
				'display':'none'
			});
			$('.alumniPwd .pwdMiddle').css({
				'width':'auto',
				'background':'#fff'
			});
			$('.alumniPwd .pwdLeft').css({
				'width':'auto',
				'padding':'0'
			});
			$('.alumniPwd .pwdCnt').css({
				'width':'auto',
				'padding':'20px 0'
			});
			$('.alumniPwd .pwdOpt').css({
				'width':'auto',
				'padding':'20px',
				'text-align':'center'
			});
			$('.alumniPwd .lbl').css({
				'width':'100px',
				'padding':'0',
				'text-align':'right',
				'height':'30px',
				'line-height':'30px'
			});
			$('.alumniPwd .txt').css('width','calc(100% - 140px)');
			$('.alumniPwd .txt input').css({
				'width':'96%',
				'height':'30px',
				'line-height':'30px'
			});
			$('#getcode').css({
				'position':'static',
				'top':'auto',
				'left':'auto',
				'display':'block',
				'height':'30px',
				'line-height':'30px',
				'color':'#fff',
				'background':'#1fa5ef'
			});
			$('.alumniPwd .msg').css({
				'height':'auto',
				'line-height':'normal',
				'padding':'10px 0'
			});
			$('.alumniPwd .pwdOpt .btnCancle').css({
				'margin-left':'20px'
			});
		}
		
		
		$(".btnOk").click(function(){
			if($(this).attr("disabled")!=true){
				var mobileStr = $.trim($("#mobile").val());
				if (mobileStr==""){
					alertNotice("请输入您的注册手机");
				}else if($("#validCode").val()==""){
					alertNotice("请输入动态码");
				}else{
					setDisabled();
					setTimeout("loginIn()",500);
				}
			}
		});
		//发送动态码
		$("#getcode").click(function(){
			sendCode(this);
		});
		
		//刷新验证码
		$("#code_img").click(function(){
			t();
		});
	});
	function alertNotice(msg){
		art.dialog({
			title: '提示',
		    content: '<div style="color:#333333;text-align:left;width:350px;">'+msg+'</div>',
		    okVal: '确定',
		    ok: function () {
		    	return true;
		    }
		});
	}
	function loginIn(){
		var formObj = $("#pwdForm");
		$.ajax({            
			type:'post',
	   		url:formObj.attr('action'),
			data:formObj.serialize(),
			dataType:'json',
			error:function(request){
				setEnabled();
				alertNotice("表单提交出错，请稍候再试.....");
			},
			success:function(data){
				setEnabled();
				if(!!data){
					if(data.code==0){
						if(!!data.msg){
							alertNotice(data.msg);
						}else{
							alertNotice("手机验证失败！");
						}
						return false;
					}else if(data.code==1){
						//验证成功，登录
						$("#mobile")[0].readOnly = true;
						$("#validCode")[0].readOnly = true;
						$(".btnOk")[0].disabled = true;
						$(".btnCancle")[0].disabled = true;
						art.dialog.tips("验证成功，正在登录...");
						//跳转
						if(top.location.href!=location.href){
							top.location.reload(); 
						}else{
							location.href = "https://register.alumni.sjtu.edu.cn/alumniHome";
						}
						return false;
					}else{
						alertNotice("手机验证失败！");
					}
				}else{
					alertNotice("手机验证失败！");
				}
			}
		});
	}
	function t() {
		var verifyImg=$("#code_img");
		verifyImg.attr("src", "https://register.alumni.sjtu.edu.cn/imgcode?&r="+(new Date));
	}
	function setDisabled(){
		$(".btnOk").val("验证中");
		$("#mobile")[0].readOnly = true;
		$("#validCode")[0].readOnly = true;
		$(".btnOk")[0].disabled = true;
		$(".btnCancle")[0].disabled = true;
	}
	function setEnabled(){
		$(".btnOk").val("确定");
		$("#mobile")[0].readOnly = false;
		$("#validCode")[0].readOnly = false;
		$(".btnOk")[0].disabled = false;
		$(".btnCancle")[0].disabled = false;
	}
	
	function sendCode(obj){
		var _this=$(obj);
		var mi=60;
		//手机号
		var hand=$.trim($("#mobile").val());
		//图片验证码
		var imgCode=$("#imgCode").val();
		if(!!hand&&!!imgCode){
			
			$("#loginerr").hide();
			
			_this.attr("disabled",true);
			_this.unbind("click");
			$.ajax({
				type:'POST',
				url:'/sendCode',
				data:'handsetFirst='+hand+'&imgcode='+imgCode+'&sub=blogin',
				dataType:'json',
				success:function(res){
					if(!!res){
						if(res.code==0){
							if(!!res.msg){
								//alert(res.msg);
								$("#loginerr span").text(res.msg);
								$("#loginerr").show();
							}else{
								//alert("短信发送失败！");
								$("#loginerr span").text("短信发送失败！");
								$("#loginerr").show();
							}
							_this.attr("disabled",false);
							_this.bind("click",function(){sendCode(_this)});
						}else if(res.code==1){
							art.dialog.tips("短信发送成功");
							setTimeout(function(){
								_this.text((mi--)+"秒重新获取").css("color","gray");
								if(mi<0){
									_this.text("获取动态码").css("color","blue");
									_this.attr("disabled",false);
									_this.bind("click",function(){sendCode(_this)});
								}else{
									setTimeout(arguments.callee,1000);
								}
							},0);
						}else if(res.code==-1){
							if(!!res.time){
								$("#loginerr span").text("请"+res.time+"秒后再重新获取获取动态码");
								$("#loginerr").show();
								
								mi=res.time;
								setTimeout(function(){
									_this.text((mi--)+"秒重新获取").css("color","gray");
									if(mi<0){
										_this.text("获取动态码").css("color","blue");
										_this.attr("disabled",false);
										_this.bind("click",function(){sendCode(_this)});
									}else{
										setTimeout(arguments.callee,1000);
									}
								},0);
							}else{
								$("#loginerr span").text("请稍候再试！");
								$("#loginerr").show();
							}
						}
					}else{
						_this.attr("disabled",false);
						_this.bind("click",function(){sendCode(_this)});
					}
					res.code != 1 && t();
				},
				complete:function(){
				},
				error:function(){
					_this.attr("disabled",false);
					_this.bind("click",function(){sendCode(_this)});
				}
			});
		}
		return false;
	}
	</script>
  </head>
  <body>
	<div class="alumniPwd">
		<div class="header">
  			<img src="https://register.alumni.sjtu.edu.cn/UI/images/pwdBanner.jpg"/>
        </div>
        <div class="mainCnt">
   			<form id="pwdForm" action="https://register.alumni.sjtu.edu.cn/blogin" method="post">
			<div class="pwdTop"></div>
			<div class="pwdMiddle">
				<div class="pwdLeft">
					<div class="pwdCnt" style="padding-top: 70px;">
						<div class="login_err_panel" style="padding-left: 156px;display:none;" id="loginerr"><span class="err_tips" style="color: #e15f63;font-size:13px;">您输入的验证码不正确，请重新输入</span></div>
						<div class="line">
							<div class="lbl">手机号:</div>
							<div class="txt">
								<input type="text" id="mobile" name="mobile" value="" maxLength="11"/>
								<p class="msg">请输入您的注册手机</p>
							</div>
						</div>
						<div class="line">
							<div class="lbl">验证码:</div>
							<div class="txt">
								<input type="text" id="imgCode" name="imgCode" value="" style="width:124px;" maxlength="4"/>
								<img alt="验证码" id="code_img" title="点击图片刷新" src="https://register.alumni.sjtu.edu.cn/imgcode?r=0.789302647345974" style="height: 26px;vertical-align: middle;cursor: pointer;"/>
								<p class="msg">为防止机器人，请输入图片验证码</p>
							</div>
						</div>
						<div class="line">
							<div class="lbl">短信动态码:</div>
							<div class="txt" style="position:relative;">
								<input type="text" id="validCode" name="validCode" value=""/>
								<p class="msg">动态码有效时间10分钟，请收到短信后尽快验证</p>
								<span id="getcode" style="position:absolute;top:0;left: 180px;display: inline-block;height: 26px;line-height: 26px;cursor: pointer;width: 80px;text-align: center;color: blue;">获取动态码</span>
							</div>
						</div>
					</div>
					<div class="pwdOpt">
						<input type="button" class="btnOk" value="登录"/>
						<input type="button" class="btnCancle" value="取消" onclick="location.href='https://register.alumni.sjtu.edu.cn/'"/>
					</div>
				</div>
			</div>
			<div class="pwdFooter"></div>
			</form>
		</div>
	</div>
  </body>
</html>